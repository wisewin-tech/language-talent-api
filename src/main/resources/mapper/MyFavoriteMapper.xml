<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 【收藏】 -->
<mapper namespace="com.wisewin.api.dao.FavoritesDAO">
    <!--查询用户课时收藏记录-->
    <select id="selectFavorites" resultType="com.wisewin.api.entity.bo.FavoritesResultBO"
            parameterType="java.util.Map">
     SELECT
	  lmf.user_id,lmf.source_id,ll.language_name,lc.course_name,lv.level_name,
        lch.chapter_name,lch.thumbnail_url
    FROM
      lt_my_favorite AS lmf
    left JOIN `lt_chapter`  AS lch ON lmf.source_id=lch.id
    left JOIN `lt_level`    AS lv ON lch.level_id=lv.id
    left JOIN `lt_course`   AS lc ON lv.course_id=lc.id
    left JOIN `lt_language` AS ll ON lc.language_id=ll.id

        <where>
            lmf.user_id=#{userId}
            <if test="source!=null">AND source=#{source}</if>
        </where>
        ORDER BY lmf.create_time DESC
        <include refid="limit" />
    </select>
    <sql id="limit">
        limit #{pageOffset},#{pageSize}
    </sql>

    <!--查询用户发现收藏记录-->
    <select id="selectDiscover" resultType="com.wisewin.api.entity.bo.DiscoverResultBO"
            parameterType="java.util.Map">
        SELECT mf.user_id,mf.source,mf.source_id,dis.title,dis.thumbnail
        FROM `lt_my_favorite` AS mf
        LEFT JOIN lt_discover AS dis
        ON dis.id=mf.source_id
        <where>
            mf.user_id=#{userId}
            <if test="source!=null">AND mf.source=#{source}</if>
        </where>
        ORDER BY mf.create_time DESC
        <include refid="limit" />
    </select>

    <insert id="insertCollect" parameterType="com.wisewin.api.entity.bo.MyFavoriteBO">
      INSERT INTO lt_my_favorite
        <set>
            <if test="userId!=null">   user_id=#{userId},</if>
            <if test="source!=null">   source=#{source},</if>
            <if test="sourceId!=null"> source_id=#{sourceId},</if>
            create_time=now()
        </set>

    </insert>
    <!--取消收藏-->
    <delete id="delCollect" parameterType="com.wisewin.api.entity.bo.MyFavoriteBO">
        DELETE FROM lt_my_favorite
        WHERE
        user_id=#{userId}
        AND source_id=#{sourceId}
    </delete>

    <!--备用-->
    <!--查询某个课程的收藏状态-->
    <select id="selectStatus"  resultType="java.lang.String"
            parameterType="com.wisewin.api.entity.bo.MyFavoriteBO">
        SELECT status
        FROM lt_my_favorite
        WHERE
        user_id=#{userId} AND source_id=#{sourceId}

    </select>

</mapper>
